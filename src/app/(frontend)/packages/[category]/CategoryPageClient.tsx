"use client";

import React, { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import { Section, Column } from "@/components/layout";
import { PackageSelector } from "@/components/molecules/PackageSelector/PackageSelector";
import { SectionTitle } from "@/components/atoms";
import styles from "../page.module.css";
import { FeaturePackageCard } from "@/components/molecules/Cards";
import { useClientSearchParams } from "@/hooks/useClientSearchParams";

interface CategoryPageClientProps {
  category: any;
  packages: any[];
  periodOptions: any[];
  packageOptions: any[];
  initialPeriod: string;
}

export function CategoryPageClient({
  category,
  packages,
  periodOptions,
  packageOptions,
  initialPeriod,
}: CategoryPageClientProps) {
  const router = useRouter();
  const { searchParams, SearchParamsLoader, getParam } =
    useClientSearchParams();
  const [selectedPeriod, setSelectedPeriod] = useState(initialPeriod);

  // Sync with URL params
  useEffect(() => {
    const period = getParam("period") || "all";
    setSelectedPeriod(period);
  }, [searchParams, getParam]);

  // Filter packages based on selected period
  const filteredPackages = useMemo(() => {
    if (selectedPeriod === "all") {
      return packages;
    }

    return packages.filter((pkg) => {
      // Assuming the package has a period field that matches the period value
      return (
        pkg.coreInfo?.period?.value === selectedPeriod ||
        pkg.coreInfo?.period?.id === selectedPeriod ||
        pkg.period?.value === selectedPeriod ||
        pkg.period?.id === selectedPeriod
      );
    });
  }, [packages, selectedPeriod]);

  const handlePeriodChange = (periodId: string) => {
    setSelectedPeriod(periodId);

    // Update URL
    const params = new URLSearchParams(searchParams || "");
    if (periodId === "all") {
      params.delete("period");
    } else {
      params.set("period", periodId);
    }

    const queryString = params.toString();
    const newUrl = queryString
      ? `/packages/${category.slug}?${queryString}`
      : `/packages/${category.slug}`;

    // Push the URL with scroll: false to prevent page jump
    router.push(newUrl, { scroll: false });
  };

  return (
    <main className={styles.main}>
      <SearchParamsLoader />
      {/* Package Selector Section */}
      <Section>
        <Column
          gap={3}
          justifyContent="start"
          alignItems="start"
          fullWidth
          className={styles.packageSelectorWrapper}
          style={{ minHeight: "150px" }}
        >
          <SectionTitle
            text={`${category.title} Packages`}
            specialWord={category.title}
          />
          <PackageSelector
            packageOptions={packageOptions}
            periodOptions={periodOptions}
            selectedPackage={category.slug}
            selectedPeriod={selectedPeriod}
            onPeriodChange={handlePeriodChange}
            showPackageSelector={true}
          />
        </Column>
      </Section>
      {/* Packages Grid */}
      <Section>
        <Column gap={4} fullWidth responsive responsiveGap="var(--space-3)">
          {filteredPackages.length > 0 ? (
            <>
              {filteredPackages.map((pkg) => (
                <FeaturePackageCard
                  key={pkg.id}
                  title={pkg.title}
                  description={
                    pkg.descriptions?.shortDescription ||
                    pkg.descriptions?.description
                  }
                  image={pkg.media?.images?.[0]?.image?.url || ""}
                  href={`/packages/${category.slug}/${pkg.slug}`}
                  price={pkg.pricing?.price}
                  originalPrice={pkg.pricing?.originalPrice}
                  duration={
                    pkg.coreInfo?.period?.shortTitle ||
                    pkg.coreInfo?.period?.title
                  }
                  locations={pkg.coreInfo?.locations || []}
                />
              ))}
            </>
          ) : (
            <div className={styles.noPackages}>
              <svg
                width="198"
                height="219"
                viewBox="0 0 198 219"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M167.439 145.151C166.231 145.151 165.252 146.14 165.252 147.358C165.252 150.072 165.044 152.731 164.734 155.363C164.048 156.24 162.124 158.304 158.679 159.036C156.23 159.549 153.512 159.26 150.558 158.24V118.715C150.558 117.497 149.58 116.508 148.372 116.508H140.332C139.124 116.508 138.145 117.497 138.145 118.715V120.677H134.267V118.715C134.267 117.497 133.288 116.508 132.08 116.508H121.992C120.784 116.508 119.805 117.497 119.805 118.715V120.898H116.017V118.715C116.017 117.497 115.038 116.508 113.831 116.508H105.064C103.857 116.508 102.878 117.497 102.878 118.715V150.561C102.878 151.782 103.857 152.772 105.064 152.772C106.272 152.772 107.251 151.782 107.251 150.561V120.925H111.644V123.105C111.644 124.326 112.623 125.315 113.831 125.315H121.988C123.196 125.315 124.175 124.326 124.175 123.105V120.925H129.887V122.884C129.887 124.105 130.866 125.094 132.074 125.094H140.329C141.536 125.094 142.515 124.105 142.515 122.884V120.925H146.179V156.261C145.122 155.676 144.046 155.036 142.936 154.282C142.128 153.731 141.042 153.792 140.295 154.438C139.76 154.907 126.987 165.718 115.402 154.52C114.968 154.098 114.419 153.901 113.787 153.907C113.188 153.935 112.626 154.213 112.236 154.673C112.196 154.72 107.964 159.552 98.989 159.552C90.1317 159.552 85.9066 154.86 85.7417 154.673C85.3515 154.213 84.7897 153.935 84.191 153.907C83.5955 153.901 83.0068 154.098 82.5763 154.52C71.0446 165.66 58.2246 154.897 57.683 154.435C56.9328 153.795 55.853 153.731 55.0456 154.282C53.9322 155.04 52.8557 155.676 51.7927 156.261V120.925H55.456V122.884C55.456 124.105 56.435 125.094 57.6426 125.094H65.8978C67.1054 125.094 68.0843 124.105 68.0843 122.884V120.925H73.7963V123.105C73.7963 124.326 74.7752 125.315 75.9829 125.315H84.1439C85.3515 125.315 86.3304 124.326 86.3304 123.105V120.925H90.7204V150.561C90.7204 151.782 91.6993 152.772 92.907 152.772C94.1146 152.772 95.0935 151.782 95.0935 150.561V118.715C95.0935 117.497 94.1146 116.508 92.907 116.508H84.1439C82.9362 116.508 81.9573 117.497 81.9573 118.715V120.898H78.1728V118.715C78.1728 117.497 77.1939 116.508 75.9863 116.508H65.8978C64.6901 116.508 63.7112 117.497 63.7112 118.715V120.677H59.8325V118.715C59.8325 117.497 58.8536 116.508 57.646 116.508H49.6061C48.3985 116.508 47.4195 117.497 47.4195 118.715V158.24C44.466 159.263 41.7446 159.549 39.3057 159.036C35.8509 158.304 33.9267 156.227 33.2506 155.36C32.9377 152.731 32.7325 150.072 32.7325 147.358C32.7325 146.14 31.7536 145.151 30.546 145.151C29.3383 145.151 28.3594 146.14 28.3594 147.358C28.3594 150.333 28.5949 153.241 28.9481 156.118C28.9481 156.332 28.9817 156.533 29.0423 156.744C30.2096 165.67 32.9545 174.1 37.0821 181.673C37.1629 181.85 37.2537 182.013 37.3782 182.166C40.1837 187.223 43.6048 191.865 47.4936 196.071C47.6248 196.343 47.8098 196.598 48.0587 196.809C48.0722 196.816 48.1933 196.915 48.3749 197.051C61.2185 210.418 79.1484 218.767 98.9991 218.767C118.846 218.767 136.786 210.418 149.63 197.044C149.808 196.908 149.923 196.816 149.936 196.809C150.182 196.602 150.367 196.35 150.498 196.078C154.397 191.868 157.821 187.216 160.63 182.149C160.738 182.017 160.815 181.87 160.893 181.717C165.023 174.134 167.785 165.697 168.953 156.757C169.016 156.543 169.05 156.332 169.047 156.118C169.397 153.241 169.635 150.333 169.635 147.361C169.629 146.141 168.65 145.151 167.439 145.151ZM38.283 163.334C43.5846 164.504 49.5792 162.98 56.1423 158.832C62.0629 163.215 73.7156 167.632 84.0732 159.083C86.4313 160.984 91.3596 163.973 98.9957 163.973C106.632 163.973 111.557 160.984 113.918 159.083C124.279 167.632 135.935 163.208 141.853 158.832C148.416 162.99 154.417 164.497 159.708 163.334C161.222 163.001 162.534 162.474 163.651 161.865C162.346 167.809 160.277 173.461 157.522 178.701C153.27 179.092 148.372 177.457 142.949 173.774C142.142 173.223 141.055 173.287 140.312 173.927C139.774 174.393 126.937 185.145 115.415 174.012C114.981 173.59 114.433 173.379 113.8 173.4C113.202 173.427 112.64 173.706 112.25 174.165C112.209 174.212 107.978 179.045 99.0025 179.045C90.1452 179.045 85.92 174.352 85.7552 174.165C85.365 173.706 84.8032 173.427 84.2044 173.4C83.609 173.376 83.0203 173.59 82.5897 174.012C71.0581 185.149 58.238 174.386 57.6964 173.927C56.9496 173.287 55.8698 173.219 55.0591 173.774C49.6364 177.453 44.7418 179.092 40.4831 178.701C37.728 173.461 35.6558 167.809 34.3539 161.865C35.4573 162.47 36.7659 163.001 38.283 163.334ZM146.68 193.756C143.945 195.816 129.833 205.382 117.528 193.5C117.101 193.082 116.515 192.882 115.92 192.892C115.324 192.916 114.763 193.191 114.369 193.64C114.164 193.871 109.266 199.336 98.9924 199.336C88.7155 199.336 83.8176 193.875 83.6258 193.654C83.2356 193.194 82.6738 192.916 82.075 192.888C81.483 192.882 80.8909 193.082 80.4603 193.5C68.1684 205.372 54.0735 195.843 51.3184 193.766C48.2269 190.518 45.4752 186.958 43.0767 183.139C47.1572 182.843 51.5269 181.238 56.1457 178.324C62.0595 182.7 73.7223 187.124 84.0732 178.575C86.4347 180.476 91.3629 183.465 98.9991 183.465C106.639 183.465 111.56 180.476 113.925 178.575C124.276 187.124 135.939 182.7 141.856 178.324C146.471 181.238 150.841 182.843 154.922 183.139C152.513 186.954 149.768 190.511 146.68 193.756ZM98.9924 214.346C85.5836 214.346 73.1134 210.272 62.6684 203.318C68.5116 204.331 75.3841 203.593 81.9405 198.084C84.5072 200.206 90.1283 203.757 98.989 203.757C107.853 203.757 113.474 200.206 116.038 198.084C122.594 203.593 129.473 204.328 135.316 203.318C124.878 210.265 112.404 214.346 98.9924 214.346Z"
                  fill="#FF8A34"
                />
                <path
                  d="M30.5527 74.3781C31.7603 74.3781 32.7393 73.3885 32.7393 72.1677C32.7393 35.2339 62.4632 5.1864 98.9991 5.1864C135.535 5.1864 165.259 35.2339 165.259 72.1677C165.259 73.3885 166.238 74.3781 167.445 74.3781C168.653 74.3781 169.632 73.3885 169.632 72.1677C169.632 32.7957 137.944 0.765625 98.9957 0.765625C60.0478 0.765625 28.3594 32.7957 28.3594 72.1677C28.3661 73.3851 29.345 74.3781 30.5527 74.3781Z"
                  fill="#FF8A34"
                />
                <path
                  d="M120.651 115.322C121.859 115.322 122.838 114.333 122.838 113.112V81.2656C122.838 80.0482 121.859 79.0586 120.651 79.0586H111.888C110.681 79.0586 109.702 80.0482 109.702 81.2656V83.4488H105.917V81.2656C105.917 80.0482 104.938 79.0586 103.731 79.0586H93.6423C92.4346 79.0586 91.4557 80.0482 91.4557 81.2656V83.2278H87.5771V81.2656C87.5771 80.0482 86.5982 79.0586 85.3905 79.0586H77.3506C76.143 79.0586 75.1641 80.0482 75.1641 81.2656V113.34C75.1641 114.561 76.143 115.55 77.3506 115.55C78.5583 115.55 79.5372 114.561 79.5372 113.34V83.4794H83.2006V85.4381C83.2006 86.6589 84.1795 87.6485 85.3871 87.6485H93.6423C94.8499 87.6485 95.8289 86.6589 95.8289 85.4381V83.4794H101.541V85.6592C101.541 86.88 102.52 87.8695 103.727 87.8695H111.888C113.096 87.8695 114.075 86.88 114.075 85.6592V83.4794H118.465V113.115C118.465 114.333 119.444 115.322 120.651 115.322Z"
                  fill="#FF8A34"
                />
                <path
                  d="M28.3587 141.932C28.3587 143.153 29.3376 144.142 30.5453 144.142C31.753 144.142 32.7319 143.153 32.7319 141.932V84.9858C35.6888 84.7274 42.2081 85.4313 46.3828 95.4664C46.736 96.3132 47.5467 96.8198 48.4012 96.8198C48.6838 96.8198 48.9731 96.7655 49.2489 96.6464C50.3624 96.1738 50.8838 94.8781 50.4196 93.7491C47.0287 85.6047 42.1442 82.3571 37.9897 81.1771C43.1702 80.5446 50.6483 81.9457 57.0667 92.2426C57.4839 92.9057 58.1937 93.273 58.9203 93.273C59.3172 93.273 59.7209 93.1642 60.0842 92.933C61.1069 92.2834 61.413 90.913 60.7671 89.886C53.3092 77.9262 44.3342 76.1136 37.9023 76.8006C42.124 74.3657 48.4752 72.7233 56.1652 77.0862C57.2181 77.6847 58.5502 77.3039 59.1423 76.2463C59.7344 75.1819 59.361 73.8319 58.308 73.2334C44.8892 65.6025 34.4845 73.213 30.552 76.94C26.6162 73.213 16.2148 65.6059 2.79603 73.2334C1.74311 73.8319 1.36971 75.1785 1.96176 76.2463C2.55382 77.3073 3.87923 77.6847 4.93887 77.0862C12.5515 72.7641 18.8858 74.3794 23.1278 76.7938C16.6959 76.1307 7.7646 77.9772 0.33698 89.886C-0.305536 90.9164 -0.00278264 92.2834 1.01986 92.933C2.0425 93.5825 3.39481 93.273 4.03396 92.2426C10.449 81.9559 17.9271 80.5514 23.1076 81.1806C18.9531 82.364 14.0687 85.6081 10.6811 93.7491C10.2136 94.8781 10.7383 96.1738 11.8518 96.6464C12.9585 97.1191 14.2503 96.5886 14.7179 95.463C18.8959 85.4177 25.4254 84.724 28.3688 84.979V141.932H28.3587Z"
                  fill="#FF8A34"
                />
                <path
                  d="M197.666 89.886C190.208 77.9262 181.233 76.1136 174.801 76.8006C179.022 74.3657 185.374 72.7233 193.064 77.0862C194.12 77.6847 195.445 77.3039 196.041 76.2463C196.633 75.1819 196.259 73.8319 195.206 73.2334C181.788 65.6025 171.383 73.213 167.45 76.940C163.518 73.213 153.107 65.6059 139.694 73.2334C138.642 73.8319 138.268 75.1785 138.86 76.2463C139.449 77.3073 140.781 77.6847 141.837 77.0862C149.45 72.7641 155.784 74.3794 160.026 76.7938C153.594 76.1307 144.66 77.9772 137.235 89.886C136.593 90.9164 136.896 92.2834 137.918 92.933C138.941 93.5825 140.293 93.273 140.932 92.2426C147.347 81.9559 154.826 80.5514 160.006 81.1806C155.852 82.364 150.967 85.6081 147.58 93.7491C147.112 94.8781 147.637 96.1738 148.75 96.6464C149.86 97.1191 151.145 96.5886 151.616 95.463C155.798 85.4211 162.324 84.724 165.267 84.979V141.929C165.267 143.149 166.246 144.139 167.454 144.139C168.662 144.139 169.64 143.149 169.64 141.929V84.9824C172.597 84.724 179.113 85.4211 183.291 95.463C183.645 96.3098 184.455 96.8164 185.31 96.8164C185.592 96.8164 185.882 96.762 186.157 96.643C187.271 96.1703 187.792 94.8747 187.328 93.7457C183.937 85.6013 179.053 82.3538 174.898 81.1738C180.079 80.5412 187.557 81.9423 193.975 92.2393C194.392 92.9024 195.102 93.2696 195.829 93.2696C196.226 93.2696 196.629 93.1608 196.993 92.9296C198.002 92.2835 198.308 90.9164 197.666 89.886Z"
                  fill="#FF8A34"
                />
              </svg>

              <p>No packages found for the selected duration.</p>
            </div>
          )}
        </Column>
      </Section>
    </main>
  );
}
